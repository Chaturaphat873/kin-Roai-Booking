<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏à‡∏≠‡∏á‡πÇ‡∏ï‡πä‡∏∞‡∏£‡πâ‡∏≤‡∏ô‡∏≠‡∏≤‡∏´‡∏≤‡∏£</title>
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { 
            background: radial-gradient(circle at top, #ffffff, #fdf3e0); 
            background-color: #fdf3e0; /* Fallback */
            font-family: 'Kanit', sans-serif; 
            padding-bottom: 50px; 
            color: #80332d; 
            min-height: 100vh;
        }
        h4 { color: #80332d; font-weight: bold; }
        .table-box {
            width: 80px; height: 80px;
            margin: 10px auto;
            border-radius: 12px;
            display: flex; flex-direction: column;
            justify-content: center; align-items: center;
            cursor: pointer; position: relative;
            box-shadow: 0 4px 10px rgba(128, 51, 45, 0.2);
            transition: transform 0.2s, box-shadow 0.2s;
            font-weight: bold;
        }
        .table-box:active { transform: scale(0.95); }
        
        /* Theme Colors: #80332d (Red/Brown), #ba9e6f (Gold) */
        .available { background-color: #ba9e6f; color: white; border: 2px solid #a38b55; }
        .busy { background-color: #80332d; color: white; border: 2px solid #5e2622; opacity: 0.9; }
        
        /* Layout */
        .zone-title { margin-top: 20px; font-weight: bold; color: #80332d; font-size: 1.2rem; }
        .grid-container { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; max-width: 400px; margin: auto; }
        
        /* Modal */
        .modal-header { background: #ba9e6f; color: white; border-bottom: none; }
        .btn-primary { background-color: #80332d; border-color: #80332d; }
        .btn-primary:hover { background-color: #6a2a25; border-color: #5e2622; }
    </style>
</head>
<body>

<div class="container text-center mt-4">
    <h4>üç¥ ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏≠‡∏á‡πÇ‡∏ï‡πä‡∏∞</h4>
    <p id="welcome-msg" class="text-muted small">Loading...</p>
    
    <div id="admin-panel" class="alert alert-info d-none">
        <strong>Admin Mode:</strong> ‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡πÇ‡∏ï‡πä‡∏∞‡∏™‡∏µ‡πÅ‡∏î‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡πÉ‡∏´‡πâ‡∏ß‡πà‡∏≤‡∏á
    </div>

    <div id="shop-closed-alert" class="alert alert-danger d-none">
        ‚õî ‡∏£‡πâ‡∏≤‡∏ô‡∏õ‡∏¥‡∏î ‡∏´‡∏£‡∏∑‡∏≠ ‡∏´‡∏°‡∏î‡πÄ‡∏ß‡∏•‡∏≤‡∏à‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡∏£‡∏±‡∏ö
    </div>

    <div class="zone-title">‡πÇ‡∏ã‡∏ô‡πÉ‡∏ô‡∏£‡πâ‡∏≤‡∏ô (Air)</div>
    <div class="grid-container" id="indoor-zone"></div>

    <hr>

    <div class="zone-title">‡πÇ‡∏ã‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏£‡πâ‡∏≤‡∏ô (Outdoor)</div>
    <div class="grid-container" id="outdoor-zone"></div>
</div>

<div class="modal fade" id="bookingModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">‡∏à‡∏≠‡∏á‡πÇ‡∏ï‡πä‡∏∞ <span id="modal-table-no"></span></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-start">
                <form id="bookingForm">
                    <div class="mb-3">
                        <label>‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô</label>
                        <input type="text" class="form-control" id="input-nickname" required>
                    </div>
                    <div class="mb-3">
                        <label>‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£ (‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö)</label>
                        <input type="tel" class="form-control" id="input-phone" required>
                    </div>
                    <div class="mb-3">
                        <label>‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÄ‡∏Ç‡πâ‡∏≤ (‡πÄ‡∏ä‡πà‡∏ô 18:30)</label>
                        <input type="time" class="form-control" id="input-time" required>
                    </div>
                    <button type="submit" class="btn btn-primary w-100">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á</button>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
    // --- CONFIGURATION ---
    const LIFF_ID = "2008809721-wkEpHOm0"; 
    const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzg0_0f7QP28CFwbXCjS7qHk4pA16ItaAHXqBpnx0SeRwJ-gHmjXIXvxnM8ovtZ-Gsn/exec";

    let userProfile = null;
    let isAdmin = false;

    const indoorTables = [7, 8, 9, 6, 5, 4, 3, 2, 1]; 
    const outdoorTables = [10, 11, 12, 14]; 

    async function main() {
        await liff.init({ liffId: LIFF_ID });
        if (!liff.isLoggedIn()) {
            liff.login();
            return;
        }
        
        userProfile = await liff.getProfile();
        document.getElementById('welcome-msg').innerText = `‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ, ${userProfile.displayName}`;
        
        checkAdminStatus();
        fetchTableStatus();
    }

    // --- ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏ä‡πá‡∏Ñ‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏õ‡∏¥‡∏î‡∏õ‡∏¥‡∏î ---
    function isShopOpen() {
        const now = new Date();
        const day = now.getDay(); // 0=Sun, 1=Mon, ..., 6=Sat
        const hour = now.getHours();

        // 1. ‡∏£‡πâ‡∏≤‡∏ô‡∏´‡∏¢‡∏∏‡∏î‡∏ó‡∏∏‡∏Å‡∏ß‡∏±‡∏ô‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå (Monday = 1)
        if (day === 1) {
            return { open: false, reason: "‡∏Ç‡∏≠‡∏≠‡∏†‡∏±‡∏¢ ‡∏£‡πâ‡∏≤‡∏ô‡∏´‡∏¢‡∏∏‡∏î‡∏ó‡∏∏‡∏Å‡∏ß‡∏±‡∏ô‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå‡∏Ñ‡∏£‡∏±‡∏ö" };
        }

        // 2. ‡∏õ‡∏¥‡∏î‡∏à‡∏≠‡∏á‡∏´‡∏•‡∏±‡∏á 2 ‡∏ó‡∏∏‡πà‡∏° (20:00)
        // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏ß‡∏•‡∏≤‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô >= 20 ‡∏ñ‡∏∑‡∏≠‡∏ß‡πà‡∏≤‡∏õ‡∏¥‡∏î‡∏£‡∏±‡∏ö‡∏à‡∏≠‡∏á
        if (hour >= 20) {
            return { open: false, reason: "‡∏õ‡∏¥‡∏î‡∏£‡∏±‡∏ö‡∏à‡∏≠‡∏á‡∏´‡∏•‡∏±‡∏á 20:00 ‡∏ô. ‡∏Ñ‡∏£‡∏±‡∏ö" };
        }

        return { open: true };
    }

    async function checkAdminStatus() {
        try {
            const res = await fetch(`${APPS_SCRIPT_URL}?op=checkAdmin&userId=${userProfile.userId}`);
            const data = await res.json();
            if (data.isAdmin) {
                isAdmin = true;
                document.getElementById('admin-panel').classList.remove('d-none');
            }
        } catch(e) { console.error(e); }
    }

    async function fetchTableStatus() {
        Swal.fire({title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...', allowOutsideClick: false, didOpen: () => Swal.showLoading()});
        try {
            const res = await fetch(`${APPS_SCRIPT_URL}?op=getStatus`);
            const data = await res.json(); 
            Swal.close();
            renderTables(data);
        } catch (error) {
            Swal.fire('Error', '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ', 'error');
        }
    }

    function renderTables(statusData) {
        const statusMap = {};
        statusData.forEach(row => statusMap[row[0]] = row[1]); 

        const createBox = (num) => {
            const status = statusMap[num] || 'Available';
            const cssClass = status === 'Available' ? 'available' : 'busy';
            const icon = status === 'Available' ? '‚úÖ' : '‚ùå';
            return `
                <div class="table-box ${cssClass}" onclick="handleTableClick(${num}, '${status}')">
                    <h6>‡πÇ‡∏ï‡πä‡∏∞ ${num}</h6>
                    <small>${icon}</small>
                </div>
            `;
        };

        document.getElementById('indoor-zone').innerHTML = indoorTables.map(num => createBox(num)).join('');
        document.getElementById('outdoor-zone').innerHTML = outdoorTables.map(num => createBox(num)).join('');
    }

    window.handleTableClick = (tableNo, status) => {
        // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô Admin ‡∏Å‡∏î‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡πÇ‡∏ï‡πä‡∏∞‡πÑ‡∏î‡πâ‡∏ï‡∏•‡∏≠‡∏î ‡πÑ‡∏°‡πà‡∏™‡∏ô‡πÄ‡∏ß‡∏•‡∏≤
        if (isAdmin && status !== 'Available') {
            Swal.fire({
                title: `Admin: ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡πÇ‡∏ï‡πä‡∏∞ ${tableNo}?`,
                text: "‡πÇ‡∏ï‡πä‡∏∞‡∏à‡∏∞‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡∏ß‡πà‡∏≤‡∏á‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: '‡πÉ‡∏ä‡πà, ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡πÄ‡∏•‡∏¢'
            }).then((result) => {
                if (result.isConfirmed) updateTableStatus(tableNo, 'admin_clear');
            });
            return;
        }

        // --- ‡πÄ‡∏ä‡πá‡∏Ñ‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ ---
        const shopStatus = isShopOpen();
        if (!shopStatus.open && !isAdmin) {
            Swal.fire('‡∏Ç‡∏≠‡∏≠‡∏†‡∏±‡∏¢', shopStatus.reason, 'error');
            return;
        }

        if (status !== 'Available') {
            Swal.fire('‡πÄ‡∏ï‡πá‡∏°', '‡πÇ‡∏ï‡πä‡∏∞‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏Ñ‡∏ô‡∏à‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡∏£‡∏±‡∏ö', 'warning');
            return;
        }

        document.getElementById('modal-table-no').innerText = tableNo;
        window.currentTableBooking = tableNo;
        new bootstrap.Modal(document.getElementById('bookingModal')).show();
    };

    document.getElementById('bookingForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        // ‡πÄ‡∏ä‡πá‡∏Ñ‡πÄ‡∏ß‡∏•‡∏≤‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏Å‡πà‡∏≠‡∏ô‡∏Å‡∏î‡∏™‡πà‡∏á (‡∏Å‡∏±‡∏ô‡πÄ‡∏´‡∏ô‡∏µ‡∏¢‡∏ß)
        const shopStatus = isShopOpen();
        if (!shopStatus.open && !isAdmin) {
             bootstrap.Modal.getInstance(document.getElementById('bookingModal')).hide();
             Swal.fire('‡∏Ç‡∏≠‡∏≠‡∏†‡∏±‡∏¢', shopStatus.reason, 'error');
             return;
        }

        const nickname = document.getElementById('input-nickname').value;
        const phone = document.getElementById('input-phone').value;
        const time = document.getElementById('input-time').value;

        bootstrap.Modal.getInstance(document.getElementById('bookingModal')).hide();

        const payload = {
            action: 'book',
            userId: userProfile.userId,
            displayName: userProfile.displayName,
            nickname: nickname,
            phone: phone,
            time: time,
            tableNo: window.currentTableBooking
        };

        await sendData(payload);
    });

    async function updateTableStatus(tableNo, action) {
        await sendData({
            action: action,
            userId: userProfile.userId,
            tableNo: tableNo
        });
    }

    async function sendData(payload) {
        Swal.fire({title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...', allowOutsideClick: false, didOpen: () => Swal.showLoading()});
        
        try {
            await fetch(APPS_SCRIPT_URL, {
                method: 'POST',
                mode: 'no-cors',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            
            setTimeout(() => {
                if(payload.action === 'book') {
                    // ‡∏ñ‡πâ‡∏≤‡∏à‡∏≠‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à -> ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô -> ‡∏õ‡∏¥‡∏î LIFF
                    Swal.fire({
                        title: '‡∏à‡∏≠‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!',
                        text: '‡πÄ‡∏£‡∏≤‡πÑ‡∏î‡πâ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡πÄ‡∏Ç‡πâ‡∏≤ LINE ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏•‡πâ‡∏ß',
                        icon: 'success',
                        timer: 2000,
                        showConfirmButton: false
                    }).then(() => {
                        liff.closeWindow(); // ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á LIFF
                    });
                } else {
                    // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô Admin ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡πÇ‡∏ï‡πä‡∏∞ -> ‡πÇ‡∏´‡∏•‡∏î‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏â‡∏¢‡πÜ
                    Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', '‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', 'success').then(() => fetchTableStatus());
                }
            }, 1500);

        } catch (error) {
            Swal.fire('Error', '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', 'error');
        }
    }

    main();
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
